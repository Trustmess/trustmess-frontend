import{j as e,r as c}from"../vendor/react/-Cgmo2qD.js";import{c as X}from"../vendor/react-dom/U6SLYLl_.js";import{F as $,a as F,b as k}from"../vendor/formik/BYZ_8MIC.js";import{c as V,a as L,b as Z}from"../vendor/yup/H4075T9H.js";import{a as D}from"../vendor/axios/C0ehD9Ac.js";import{u as b,N as ee,R as se,a as C,B as ne}from"../vendor/react-router/BNL20ZkH.js";import{M as I,a as te,b as M,c as E,d as re}from"../vendor/react-icons/RLdM0nCd.js";import{R as q}from"../vendor/react-modal/DSOp-dqK.js";import"../vendor/cookie/DaWZu8wl.js";import"../vendor/scheduler/efY9L43x.js";import"../vendor/deepmerge/DhIoniG1.js";import"../vendor/lodash-es/Bw_lT_GB.js";import"../vendor/react-fast-compare/BRlOzeI3.js";import"../vendor/hoist-non-react-statics/CjKdNK1C.js";import"../vendor/react-is/CnyDuYXe.js";import"../vendor/property-expr/DwgEMw67.js";import"../vendor/tiny-case/Gl8mQWqo.js";import"../vendor/toposort/DxMdbltD.js";import"../vendor/prop-types/Chjiymov.js";import"../vendor/warning/C20GYw-A.js";import"../vendor/exenv/DrHgoSea.js";import"../vendor/react-lifecycles-compat/DWDm52h3.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const t of r)if(t.type==="childList")for(const a of t.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function o(r){const t={};return r.integrity&&(t.integrity=r.integrity),r.referrerPolicy&&(t.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?t.credentials="include":r.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function i(r){if(r.ep)return;r.ep=!0;const t=o(r);fetch(r.href,t)}})();const p=({className:s,dataTheme:n,onClick:o,children:i,type:r="button",disabled:t=!1})=>e.jsx("button",{className:s,"data-theme":n,onClick:o,type:r,disabled:t,children:i}),oe="/",ae=D.create({baseURL:oe,withCredentials:!0}),ie=()=>["/"],ce=async s=>{try{const n=new AbortController,o=setTimeout(()=>n.abort(),500);if(s==="/"||s==="")return clearTimeout(o),console.log("Api proxy available at /"),!0;const i=s.endsWith("/")?s.slice(0,-1):s;return await ae.get(i,{signal:n.signal,timeout:2e3}),clearTimeout(o),console.log(`Api avaible: ${s}`),!0}catch{return console.log(`Api unavaible: ${s}`),!1}},le=async()=>{const s=ie();console.log("Search working API in:",s);const o=(await Promise.allSettled(s.map(async i=>{if(await ce(i))return i;throw new Error(`${i} is not avaible`)}))).find(i=>i.status==="fulfilled");if(o){const i=o.value.endsWith("/")?o.value:o.value+"/";return console.log("Use Api: ",i),i}return console.warn("All APIs are not avaibles, return fallback",s[0]),s[0].endsWith("/")?s[0]:s[0]+"/"};let P=null;const B=async()=>P||(P=await le(),P);let U=null,W=null;const de=async()=>(U||(U=await B()),U),me=async()=>(U||await de(),U),R=async()=>{if(!W){const s=await me();W=D.create({baseURL:s,withCredentials:!0,headers:{"Content-Type":"application/json"}})}return W},z=async s=>{try{return(await(await R()).post("auth/login",{username:s.username,password:s.password})).data}catch(n){throw console.log("Something wrong, "+n),n}},ue=async s=>{try{return(await(await R()).post("auth/register",{username:s.username,password:s.password})).data}catch(n){throw console.log("Something wrong, "+n),n}},ge=async s=>{try{const o=(await R()).post("auth/delete_user",{username:s})}catch(n){throw n}},J=c.createContext(),he=({children:s})=>{const[n,o]=c.useState(null),[i,r]=c.useState(!1),[t,a]=c.useState(!0),m=g=>{o(g),r(!0),localStorage.setItem("user",JSON.stringify(g))},l=()=>{o(null),r(!1),localStorage.removeItem("user")};c.useEffect(()=>{const g=localStorage.getItem("user");g&&(o(JSON.parse(g)),r(!0)),a(!1)},[]);const u=c.useMemo(()=>({user:n,isAuthenticated:i,login:m,logout:l,loading:t}),[n,i]);return e.jsx(J.Provider,{value:u,children:s})},_=()=>c.useContext(J),K=c.createContext(null),pe=()=>{if(typeof window=="undefined")return"light";const s=localStorage.getItem("theme");if(s==="dark"||s==="light")return s;const n=typeof window.matchMedia=="function"?window.matchMedia("(prefers-color-scheme: dark)"):null;return n!=null&&n.matches?"dark":"light"},fe=({children:s})=>{const[n,o]=c.useState(pe);c.useEffect(()=>{document.documentElement.setAttribute("data-theme",n),localStorage.setItem("theme",n)},[n]),c.useEffect(()=>{const t=typeof window.matchMedia=="function"?window.matchMedia("(prefers-color-scheme: dark)"):null;if(!t)return;const a=m=>{o(m.matches?"dark":"light")};return t.addEventListener?t.addEventListener("change",a):t.addListener&&t.addListener(a),()=>{t.removeEventListener?t.removeEventListener("change",a):t.removeListener&&t.removeListener(a)}},[]);const i=()=>{o(t=>t==="dark"?"light":"dark")},r=c.useMemo(()=>({theme:n,toggleTheme:i}),[n]);return e.jsx(K.Provider,{value:r,children:s})},A=()=>{const s=c.useContext(K);if(!s)throw new Error("useTheme must be used within a ThemeProvider");return s},G=c.createContext(),xe=({children:s})=>{const{user:n,isAuthenticated:o}=_(),[i,r]=c.useState([]),[t,a]=c.useState(!1),[m,l]=c.useState([]),u=c.useRef(null),g=c.useRef(!0),h=c.useRef(0),j=5,d=c.useRef(new Map);c.useEffect(()=>(o&&n?(console.log("Attempting WebSocket connection for user:",n.username),g.current=!0,h.current=0,v()):(g.current=!1,h.current=0,T()),()=>{g.current=!1,h.current=0,T()}),[o,n]);const v=async()=>{try{const N=await B();if(!N){console.error("No working API found");return}const y=((w,f)=>{let x;try{x=new URL(w)}catch{x=new URL(w,window.location.origin)}x.protocol=x.protocol==="https:"?"wss:":"ws:";const S=x.pathname.replace(/\/+$/,"");return x.pathname=`${S}/ws/${f}`,x.toString()})(N,n.id);console.log("Connecting to WebSocked:",y),u.current=new WebSocket(y),u.current.onopen=()=>{console.log("WebSocket Connected"),a(!0),h.current=0},u.current.onmessage=w=>{const f=JSON.parse(w.data);if(console.log("WebSocket message received:",f),f.type==="online_users")console.log("Updating online users:",f.users),r(f.users);else if(f.type==="chat_message"){const x={id:f.message_id,senderId:f.sender_id,recipientId:f.recipient_id,content:f.content,timestamp:f.timestamp};l(S=>[...S,x]),d.current.forEach(S=>S(x))}else f.type==="message_sent"&&console.log("Message sent confirmation:",f.message_id)},u.current.onerror=w=>{console.error("WebSocket ERROR:",w)},u.current.onclose=w=>{console.log("WebSocket CLOSED:",w.code,w.reason),a(!1),g.current&&o&&n?h.current<j?(h.current+=1,console.log(`Attempting to reconnect in 3 seconds... (Attempt ${h.current}/${j})`),setTimeout(()=>{v()},3e3)):(console.warn(`Maximum reconnection attempts (${j}) reached. Giving up.`),g.current=!1):console.log("Reconnect disabled (user logged out or max attempts reached)")}}catch(N){console.error("Failed to connect WebSocket:",N)}},Y=c.useCallback((N,O)=>{if(u.current&&u.current.readyState===WebSocket.OPEN){const y={type:"chat_message",recipient_id:N,content:O,timestamp:new Date().toISOString(),message_id:Date.now()};u.current.send(JSON.stringify(y)),console.log("Message sent:",y)}else console.error("WebSocket is not connected")},[]),T=()=>{u.current&&(console.log("Disconnecting WebSocket"),u.current.close(),u.current=null,a(!1),r([]))},Q={onlineUsers:i,isConnected:t,sendMessage:Y,messages:m,setMessages:l};return e.jsx(G.Provider,{value:Q,children:s})},H=()=>c.useContext(G),we=V({username:L().min(6,"Use minimum 6 symbols").required("Enter login"),password:L().min(6,"Use minimum 6 symbols").required("Enter password")}),je=()=>{const s=b(),{login:n}=_(),o=async(i,{setSubmitting:r,setErrors:t})=>{try{const a=await z(i);console.log("Successfull response from server:",a.user),a.status==="success"?(console.log("Login Successfull:",a.user.username),n(a.user),s("/messenger")):(console.log("Login failed"),t({submit:"Wrong login or password"})),r(!1)}catch(a){console.error("Login error:",a),t({submit:"Login failed"}),r(!1)}};return e.jsx($,{initialValues:{username:"",password:""},validationSchema:we,onSubmit:o,children:({isSubmitting:i,errors:r})=>e.jsxs(F,{children:[e.jsx("div",{className:"form_title",children:"Enter login and password"}),e.jsx(k,{name:"username",children:({field:t,meta:a})=>e.jsx("div",{className:`login_label ${a.touched&&a.error?"input-error":""}`,children:e.jsx("input",{...t,type:"text",placeholder:a.touched&&a.error?a.error:"Username"})})}),e.jsx(k,{name:"password",children:({field:t,meta:a})=>e.jsx("div",{className:`password_label ${a.touched&&a.error?"input-error":""}`,children:e.jsx("input",{...t,type:"password",placeholder:a.touched&&a.error?a.error:"Password"})})}),r.submit&&e.jsx("div",{className:"error_message submit_error",children:r.submit}),e.jsx(p,{className:"btn log_in_btn",type:"submit",disabled:i,children:i?"Loading...":"Log In"})]})})},ve=V({username:L().min(6,"Use minimum 6 symbols").max(20,"Use max 20 symbols").required("Enter login"),password:L().min(6,"Use minimum 6 symbols").max(20,"Use max 20 symbols").required("Enter password"),confirmPassword:L().oneOf([Z("password"),null],"Passwords is not same").required("Confirm password")}),be=()=>{const s=b(),{login:n}=_(),[o,i]=c.useState(!1),r=async(t,{setSubmitting:a,setErrors:m,resetForm:l})=>{i(!0);try{const u=await ue(t),g=await z(t);console.log("Successfull response from server:",g.user),g.status==="success"?(console.log("Login Successfull:",g.user.username),n(g.user,g.access_token),s("/messenger")):(console.log("Login failed"),m({submit:"Wrong login or password"})),l()}catch(u){console.error("Failed to create user:",u)}finally{i(!1),a(!1)}};return e.jsx($,{initialValues:{username:"",password:"",confirmPassword:""},validationSchema:ve,onSubmit:r,children:({isSubmitting:t,errors:a})=>e.jsxs(F,{children:[e.jsx("div",{className:"form_title",children:"Create account"}),e.jsx(k,{name:"username",children:({field:m,meta:l})=>e.jsx("div",{className:`login_label ${l.touched&&l.error?"input-error":""}`,children:e.jsx("input",{...m,type:"text",placeholder:l.touched&&l.error?l.error:"Username"})})}),e.jsx(k,{name:"password",children:({field:m,meta:l})=>e.jsx("div",{className:`password_label ${l.touched&&l.error?"input-error":""}`,children:e.jsx("input",{...m,type:"password",placeholder:l.touched&&l.error?l.error:"Password"})})}),e.jsx(k,{name:"confirmPassword",children:({field:m,meta:l})=>e.jsx("div",{className:`password_label ${l.touched&&l.error?"input-error":""}`,children:e.jsx("input",{...m,type:"password",placeholder:l.touched&&l.error?l.error:"Confirm Password"})})}),a.submit&&e.jsx("div",{className:"error_message submit_error",children:a.submit}),e.jsx(p,{className:"btn sign_up_btn",type:"submit",disabled:o,children:o?"Wait...":"Sign Up"})]})})},_e=({userName:s="Unknown",onClick:n,isActive:o})=>{const i=()=>{const r=s.trim().split(/\s+/);return r.length>=2?(r[0][0]+r[1][0]).toUpperCase():s.length>=2?s.slice(0,2).toUpperCase():s.toUpperCase()};return e.jsxs("div",{className:`contact_card_container ${o?"active":""}`,onClick:n,style:{cursor:"pointer"},children:[e.jsx("div",{className:"contact_card_container_ico",children:i()}),e.jsx("div",{className:"contact_card_container_name",children:s})]})},Ne=({selectedContact:s,onClose:n})=>{const{sendMessage:o,messages:i,onlineUsers:r}=H(),{user:t}=_(),[a,m]=c.useState(""),l=c.useMemo(()=>{const d=new Map;return t&&d.set(t.id,t.username),s&&d.set(s.id,s.username),Array.isArray(r)&&r.forEach(v=>{v!=null&&v.id&&d.set(v.id,v.username)}),d},[r,t,s]),u=d=>d?l.get(d)||`User ${d}`:"Unknown",g=i.filter(d=>d.senderId===t.id&&d.recipientId===(s==null?void 0:s.id)||d.senderId===(s==null?void 0:s.id)&&d.recipientId===t.id),h=()=>{if(typeof n=="function"){n();return}},j=()=>{if(!s){alert("Choose contact");return}a.trim()&&(o(s.id,a),m(""))};return s?e.jsxs("div",{className:"messeges_window",children:[e.jsx("div",{className:"messeges_history",children:g.map(d=>e.jsxs("div",{className:`message ${d.senderId===t.id?"sent":"received"}`,children:[e.jsx("div",{className:"message_sender",children:u(d.senderId)}),e.jsx("div",{className:"message_timestamp",children:new Date(d.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1})}),e.jsx("div",{className:"message_content",children:d.content})]},d.id))}),e.jsxs("div",{className:"action_bar",children:[e.jsx(p,{className:"btn back_btn",onClick:h,children:e.jsx(I,{className:"material-icons"})}),e.jsx("input",{className:"message_input",value:a,onChange:d=>m(d.target.value),onKeyDown:d=>{d.key==="Enter"&&(d.preventDefault(),j())},placeholder:"Enter message"}),e.jsx(p,{className:"btn send_message_btn",onClick:j,children:e.jsx(te,{})})]})]}):e.jsx("div",{className:"messeges_window",children:e.jsx("div",{className:"no_contact_selected",children:"Choose user for communicate"})})},ye=({isOpen:s,onRequestClose:n,title:o,children:i,shouldCloseOnOverlayClick:r=!0,className:t=""})=>e.jsxs(q,{isOpen:s,onRequestClose:n,shouldCloseOnOverlayClick:r,overlayClassName:"modal-overlay",className:`modal-content ${t}`,children:[o&&e.jsx("h2",{className:"modal-title",children:o}),e.jsx("div",{className:"modal-body",children:i})]}),Se=({isOpen:s,onRequestClose:n,username:o})=>{const{theme:i,toggleTheme:r}=A(),{user:t,isAuthenticated:a,logout:m}=_(),[l,u]=c.useState("settings"),g=b(),h=()=>{u("settings"),n()},j=async()=>{try{const d=await ge(t.username);m(),g("/")}catch(d){console.error("Delete account error:",d),alert("Failed to delete account")}finally{h()}};return e.jsx(ye,{className:"modal_window",isOpen:s,onRequestClose:h,title:"Settings ",shouldCloseOnOverlayClick:!1,children:l==="settings"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"actions",children:[e.jsx(p,{className:"btn change_theme_btn",onClick:n,children:e.jsx(I,{className:"material-icons"})}),e.jsx(p,{className:"btn change_theme_btn",dataTheme:i,onClick:r,children:i==="dark"?e.jsx(M,{className:"theme_ico"}):e.jsx(E,{className:"theme_ico"})})]}),e.jsx(p,{className:"btn btn_account_settings",dataTheme:i,onClick:()=>u("account"),children:"Account Settings"}),e.jsx(p,{className:"btn btn_log_out",onClick:()=>{m(),g("/")},children:"Log out"})]}):e.jsx(e.Fragment,{children:e.jsx(ke,{className:"account_settings_component",onBack:()=>u("settings"),onCancel:()=>u("settings"),onConfirmDelete:j})})})},ke=({onConfir:s,onBack:n,onConfirmDelete:o,onCancel:i,className:r})=>e.jsxs("div",{className:r,children:[e.jsx(p,{className:" btn btn_cancel",onClick:i!=null?i:n,children:"Cancel"}),e.jsx(p,{className:"btn btn_danger",onClick:o,children:"Delete Account"})]}),Le=()=>{const s=b(),{theme:n,toggleTheme:o}=A();return e.jsxs("div",{className:"welcome_page",id:"welcomePage",children:[e.jsx("nav",{className:"nav_line",id:"navLine",children:e.jsx(p,{className:"btn change_theme_btn",dataTheme:n,onClick:o,children:n==="dark"?e.jsx(M,{className:"theme_ico"}):e.jsx(E,{className:"theme_ico"})})}),e.jsxs("div",{className:"welcome_page_container",children:[e.jsx("div",{className:"welcome_page_title",children:"TrustMess"}),e.jsx(p,{className:"btn sign_up_btn",onClick:()=>s("/signup"),children:"Sign Up"}),e.jsx(p,{className:"btn log_in_btn",onClick:()=>s("/login"),children:"Log In"})]})]})},Ue=()=>{const s=b(),{theme:n,toggleTheme:o}=A();return e.jsxs("div",{className:"login_page",id:"loginPage",children:[e.jsx("nav",{className:"nav_line",id:"navLine",children:e.jsx(p,{className:"btn change_theme_btn",dataTheme:n,onClick:o,children:n==="dark"?e.jsx(M,{className:"theme_ico"}):e.jsx(E,{className:"theme_ico"})})}),e.jsx(je,{}),e.jsx(p,{className:"btn back_btn",onClick:()=>s("/"),children:e.jsx(I,{className:"material-icons"})})]})},Ae=()=>{const s=b(),{theme:n,toggleTheme:o}=A();return e.jsxs("div",{className:"signup_page",id:"signupPage",children:[e.jsx("nav",{className:"nav_line",id:"navLine",children:e.jsx(p,{className:"btn change_theme_btn",dataTheme:n,onClick:o,children:n==="dark"?e.jsx(M,{className:"theme_ico"}):e.jsx(E,{className:"theme_ico"})})}),e.jsx(be,{}),e.jsx(p,{className:"btn back_btn",onClick:()=>s("/"),children:e.jsx(I,{className:"material-icons"})})]})},Ce=()=>{const{user:s,isAuthenticated:n,logout:o}=_(),{theme:i,toggleTheme:r}=A(),{onlineUsers:t,isConnected:a}=H(),[m,l]=c.useState(null),[u,g]=c.useState(!1);return console.log("Online users:",t),console.log("Connected:",a),c.useEffect(()=>{const h=()=>{document.documentElement.style.setProperty("--vh",`${window.innerHeight*.01}px`)};return h(),window.addEventListener("resize",h),window.visualViewport&&window.visualViewport.addEventListener("resize",h),()=>{window.removeEventListener("resize",h),window.visualViewport&&window.visualViewport.removeEventListener("resize",h)}},[]),a?e.jsxs("div",{className:"messenger_page",children:[e.jsxs("nav",{className:"nav_line",id:"navLine",children:[e.jsxs("div",{className:"user_block",children:[e.jsxs("div",{className:"auth_user_div",children:[s==null?void 0:s.username," "]}),e.jsx("div",{className:"online_status_div",children:a?"Online":"Offline"})]}),e.jsx("div",{className:"actions_block",children:e.jsx(p,{className:"btn change_theme_btn",onClick:()=>{g(!0)},children:e.jsx(re,{})})})]}),e.jsx(Se,{isOpen:u,onRequestClose:()=>g(!1),username:s==null?void 0:s.username}),e.jsxs("main",{className:`messenger_container ${m?"chat_open":""}`,children:[e.jsx("div",{className:"contacts_panel",children:a?t.length===0?e.jsx("div",{className:"no-users-message",children:"No users online"}):t.filter(h=>h.id!==s.id).map(h=>e.jsx(_e,{userName:h.username,onClick:()=>l(h),isActive:(m==null?void 0:m.id)===h.id},h.id)):e.jsx("div",{className:"connecting-message",children:"Connecting to server..."})}),e.jsx("div",{className:"dialog_panel",children:e.jsx(Ne,{className:"messeges_window",selectedContact:m,onClose:()=>l(null)})})]})]}):e.jsx("div",{children:"Loading..."})},Pe=({children:s})=>{const{isAuthenticated:n,loading:o}=_(),i=b(),r=()=>{console.log("return to log in page"),i("/login")};return o?e.jsxs("div",{className:"loading_page",id:"loadingPage",children:[e.jsx("div",{className:"loading_circle",children:e.jsx("div",{className:"loading_text",children:"Loading..."})}),e.jsx("button",{className:"btn",onClick:r,children:"Return back"})]}):n?s:(console.log("You are not log in"),e.jsx(ee,{to:"/login",replace:!0}))},Ie=()=>e.jsxs(se,{children:[e.jsx(C,{path:"/",element:e.jsx(Le,{})}),e.jsx(C,{path:"/login",element:e.jsx(Ue,{})}),e.jsx(C,{path:"/signup",element:e.jsx(Ae,{})}),e.jsx(C,{path:"/messenger",element:e.jsx(Pe,{children:e.jsx(Ce,{})})})]});q.setAppElement("#root");X.createRoot(document.getElementById("root")).render(e.jsx(c.StrictMode,{children:e.jsx(ne,{basename:"/",children:e.jsx(he,{children:e.jsx(fe,{children:e.jsx(xe,{children:e.jsx(Ie,{})})})})})}));
